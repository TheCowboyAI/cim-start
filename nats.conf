# Copyright 2025 - Cowboy AI, LLC
# CIM NATS Server Configuration for Domain Event Storage

# Server settings
server_name: "cim-nats-1"
listen: 0.0.0.0:4222
monitor_port: 8222

# Logging
logtime: true
log_file: "/data/nats.log"
debug: false
trace: false

# Connection limits
max_connections: 1000
max_payload: 8MB
max_pending: 64MB

# JetStream configuration
jetstream {
    # Storage directory
    store_dir: "/data/jetstream"
    
    # Memory and file storage limits
    max_memory_store: 1GB
    max_file_store: 10GB
    
    # Domain for multi-tenancy
    domain: "cim"
    
    # Unique server identifier
    unique_tag: "cim-nats-1"
}

# Accounts for domain separation
accounts {
    # System account for NATS management
    SYS {
        users = [
            {
                user: "system"
                password: "system_pass"
            }
        ]
    }
    
    # Domain account for event sourcing
    DOMAIN {
        users = [
            {
                user: "domain_user"
                password: "domain_pass"
            }
        ]
        
        # JetStream permissions
        jetstream: enabled
        
        # Subject permissions based on domain algebra
        permissions = {
            publish = {
                allow: [
                    "dev.domain.>",
                    "dev.command.>", 
                    "dev.projection.>",
                    "dev.saga.>",
                    "staging.domain.>",
                    "staging.command.>",
                    "staging.projection.>", 
                    "staging.saga.>",
                    "prod.domain.>",
                    "prod.command.>",
                    "prod.projection.>",
                    "prod.saga.>"
                ]
            }
            subscribe = {
                allow: [
                    "dev.>",
                    "staging.>", 
                    "prod.>"
                ]
            }
        }
    }
    
    # Read-only account for projections and queries
    QUERY {
        users = [
            {
                user: "query_user"
                password: "query_pass"
            }
        ]
        
        jetstream: enabled
        
        permissions = {
            publish = {
                allow: [
                    "dev.projection.>",
                    "staging.projection.>",
                    "prod.projection.>"
                ]
            }
            subscribe = {
                allow: [
                    "dev.domain.>",
                    "dev.projection.>",
                    "staging.domain.>", 
                    "staging.projection.>",
                    "prod.domain.>",
                    "prod.projection.>"
                ]
            }
        }
    }
}

# System account
system_account: "SYS"

# Cluster configuration for future horizontal scaling
cluster {
    name: "cim-cluster"
    listen: 0.0.0.0:6222
    
    # Routes to other nodes (empty for single node)
    routes = []
    
    # Authorization for clustering
    authorization {
        user: "cluster_user"
        password: "cluster_pass"
        timeout: 2
    }
}

# TLS configuration (disabled for development)
# tls {
#     cert_file: "/etc/ssl/certs/nats.crt"
#     key_file: "/etc/ssl/private/nats.key"
#     ca_file: "/etc/ssl/certs/ca.crt"
#     verify: true
# }

# HTTP monitoring
http_port: 8222

# Profiling (development only)
prof_port: 6060